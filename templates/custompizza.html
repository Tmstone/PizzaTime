<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Black Belt Pizza | Custom Pizza</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

     <!-- jQuery-ui -->
     <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
     <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
         $(function(){
               var order_id={{order.id}};
               var order_total={{order.total()}};
               var price_size={
                    {% for size in sizes %}
                    {{size.id}}:{{size.price}},
                    {% endfor %}
                    placeholder:0
               };
               var scaling_size={
                    {% for size in sizes %}
                         {% if size.scaling %}
                    {{size.id}}:{{size.scaling}},
                         {% else %}
                    {{size.id}}:1,
                         {% endif %}
                    {% endfor %}
                    placeholder:0
               }

               var price_style={
                    {% for style in styles %}
                    {{style.id}}:{{style.price}},
                    {% endfor %}
                    placeholder:0
               };
               var price_topping={
                    {% for topping in toppings_menu %}
                    {{topping.id}}:{{topping.price}},
                    {% endfor %}
                    placeholder:0
               };

               // Calculates a live price of a pizza with the current configuration
               //$("#pizza_config").on("change","[name='size']",function(){
               $("#pizza_config").children().change(function(){
                    if ($(this).attr("name")=="size"){
                         //update topping prices
                         var scaling=scaling_size[$("[name='size']").val()]
                         $(".topping_price").each(function(i){
                              //console.log($(this).attr("topping_id"));
                              //console.log(price_topping[$(this).attr("topping_id")]);
                              //console.log(scaling);
                              let price=price_topping[$(this).attr("topping_id")]*scaling;
                              $(this).text("$"+price.toFixed(2));
                         })
                    }
                    let preview_price=(price_size[$("[name='size']").val()]+ price_style[$("[name='style']").val()]);
                    $("[name='topping']").each(function(i){
                         if ($(this).prop("checked")){
                              //console.log($(this).val());
                              preview_price+=price_topping[$(this).val()]
                         }
                    })
                    //console.log(preview_price);
                    $("#preview_price").text("$"+preview_price.toFixed(2)+" ea");
               });

               calc_preview_price();
               //just calling this on load.  Could be cleaned up to avoid duplicate code
               function calc_preview_price(){
                    if ($(this).attr("name")=="size"){
                         var scaling=scaling_size[$("[name='size']").val()]
                         $(".topping_price").each(function(i){
                              let price=price_topping[$(this).attr("topping_id")]*scaling;
                              $(this).text("$"+price.toFixed(2));
                         })
                    }
                    let preview_price=(price_size[$("[name='size']").val()]+ price_style[$("[name='style']").val()]);
                    $("[name='topping']").each(function(i){
                         if ($(this).prop("checked")){
                              //console.log($(this).val());
                              preview_price+=price_topping[$(this).val()]
                         }
                    })
                    console.log(preview_price);
                    $("#preview_price").text("$"+preview_price.toFixed(2)+" ea");
               }

               // Remove a pizza from the order table
               //$(".remove_pizza").click(function(){
               $("tbody").on("click",".remove_pizza",function(e){
                    console.log("delete pizza " +$(this).attr("pizza_id"));
                    let pizza_id=$(this).attr("pizza_id");
                    $.ajax({
                         method:'POST',
                         url:"/remove/pizza",
                         data:{json: JSON.stringify({'pizza_id':$(this).attr("pizza_id")})}
                    })
                    .done(function(resp_data){
                         $.ajax({
                              method: "GET",
                              url:"/total"
                         }).done(function(resp){
                              $("#order_total").text("Total: $"+resp);
                         });
                    });                    
                    $("[tr_pizza_id="+pizza_id+"]").remove();
               });

               // Add a pizza to the order
               $("#pizza_config").submit(function(){
                    $.ajax({
                         method: $(this).attr("method"),
                         url: $(this).attr("action"),
                         data:$(this).serialize()
                    })
                    .done(function(resp_data){
                         $("tbody").append(resp_data);
                         $.ajax({
                              method: "GET",
                              url:"/total"
                         }).done(function(resp){
                              $("#order_total").text("Total: $"+resp);
                         });
                    });
                    return false;
               });

               // Clear all the pizzas from the current order
               $("#clear_order").click(function(){
                    //console.log("clear order");
                    $.ajax({
                         method: "POST",
                         url: "/remove/pizzas",
                         data: {json: JSON.stringify({"order_id":order_id})}
                    })
                    $("tbody").html(null);
                    $("#order_total").text("Total: $0.00");
               });
          });

    </script>
</head>
<body>
    <div class="container">
        <div id="nav"></div>
        <div class="section" id="order-summary">
            <div class="row">
                 <div class="col-lg-7">
                      <h2>Order Summary</h2>
                      <table class="table table-striped table-dark">
                           <thead>
                                <tr>
                                     <th>Qty</th>
                                     <th>Size</th>
                                     <th>Crust</th>
                                     <th>Toppings</th>
                                     <th>Subtotal</th>
                                     <th>Action</th>
                                </tr>
                           </thead>
                           <tbody>
                                {% for pizza in order.pizzas %}
                                <tr tr_pizza_id="{{pizza.id}}">
                                     <td>{{pizza.qty}}</td>
                                     <!-- <td><input type="number" name="qty" value="{{pizza.qty}}"></td> -->

                                     <td>{{pizza.size.name}}</td>
                                     <!-- <td><input type="text" name="pizza_size" value="{{pizza.size.name}}"></td> -->

                                     <td>{{pizza.style.name}}</td>
                                     <!-- <td><input type="text" name="pizza_style" value="{{pizza.style.name}}"></td> -->

                                     <td>{% for topping in pizza.toppings %}
                                           {{topping.info.name}}
                                         {% endfor %}
                                     </td>
                                     <td>
                                          {% set pizza_price="%.2f" % pizza.price() %}
                                          ${{pizza_price}}
                                     </td>
                                     <td>
                                          <!-- <div class="dropdown">
                                               <button class="btn btn-link btn-sm dropdown-toggle btn-reveal" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><ion-icon name="ios-more"></ion-icon></button>
                                               <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                                    <a class="dropdown-item" href="#">Update</a> -->
                                                    <!-- <a class="dropdown-item text-danger" pizza_id="{{pizza.id}}" href="#">Remove</a> -->
                                                    <!-- <button class="remove_pizza dropdown-item text-danger" pizza_id="{{pizza.id}}">Remove</button> -->
                                                    <button class="remove_pizza btn btn-sm btn-danger" pizza_id="{{pizza.id}}">Remove</button>
                                               <!-- </div>
                                          </div> -->
                                     </td>
                                     <!-- <td>
                                          <a href="#">update</a>
                                          <a href="#">remove</a>
                                     </td> -->
                              </tr>
                              {% endfor%}
                           </tbody>
                      </table>
                      <!--  -->
                      {% set total_str="%.2f" % order.total() %}
                      <p id="order_total">Total: ${{total_str}}</p>
                      <a class="btn btn-sm btn-primary" href="/checkout">Submit Order</a>
                      <button id="clear_order" class="btn btn-sm btn-danger mx-3">CLEAR</button>
                 </div>
                 <div class="col-lg-4">
                      <form id="pizza_config" action="/add_pizza" method="POST">
                          <div class="form-group">
                               <label for="order_type">ORDER TYPE</label>
                               <select name="order_type" id="">
                                   {% for ordertype in order_types %}
                                   <option value="{{ordertype.id}}">{{ordertype.name}}</option>
                                   {% endfor%}
                               </select>
                          </div>
                          <div class="form-row">
                               <div class="form-group col-md-4">
                                    <label for="size">SIZE</label>
                                    <select name="size" id="">
                                        {% for size in sizes %}
                                        <option value="{{size.id}}">{{size.name}}</option>
                                        {% endfor %}
                                    </select>
                               </div>
                               <div class="form-group col-md-4">
                                    <label for="style">CRUST</label>
                                    <select name="style" id="">
                                        {% for style in styles %}
                                        <option value="{{style.id}}">{{style.name}}</option>
                                        {% endfor %}
                                    </select>
                               </div>
                          </div>
                          <div class="form-group col-md-4">
                              <label for="qty">QTY</label>
                              <input type="number" name="qty" value="1">
                          </div>
                          <div>
                              {% for topping in toppings_menu %}
                              {% set topping_str=topping.name %}
                              {# set topping_str=topping_str.ljust(30,'.') #}
                              {% set topping_price="%.2f" %topping.price %}
                              <input type="checkbox" name="topping" value="{{topping.id}}"><span topping_id={{topping.id}}  class="topping_name">{{topping_str}}</span><span topping_id={{topping.id}} class="topping_price">${{topping_price}}</span><br>
                              {% endfor %}
                          </div>
                          <p id="preview_price"> </p>
                          <input id="add_pizza" class="btn btn-sm btn-primary" type="submit" value="ADD TO ORDER">
                      </form>
                 </div>
            </div>
            
       </div>
    </div>
    <script src="https://unpkg.com/ionicons@4.5.5/dist/ionicons.js"></script>
    <!-- add popper.min.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>
